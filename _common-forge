# vim: set ft=make:
#
# Copyright (c) 2016-2017, Ryan V. Bissell
# All rights reserved.
#
# SPDX-License-Identifier: MIT
# See the enclosed "LICENSE.forge" file for exact license terms.
#

ifndef __mf_common_include_guard
override __mf_common_include_guard:=1

ifndef MFOUT
_mfcommon:=$(notdir $(lastword $(MAKEFILE_LIST)))
_mfcaller:=$(notdir $(lastword $(wordlist 2,$(words $(MAKEFILE_LIST)),foo $(MAKEFILE_LIST))))
$(error INTERNAL ERROR: $(_mfcaller) should have guaranteed that 'MFOUT' was defined before including $(_mfcommon))
endif
$(MFOUT):
	@$(test) mkdir -p $(MFOUT)


# TODO, see make-forge.mk
########.PHONY: clean


# .d files are precious because they serve to speed up subsequent builds.
# .i files are precious because the user specifically asked for them.
.PRECIOUS: $(MFOUT)/%.d $(MFOUT)/%.i


# enable paralellism based on number of available processors
# I believe this is the most portable solution (nearly POSIX)
override mf_numprocs:=$(shell getconf _NPROCESSORS_ONLN)
override MAKEFLAGS+= --jobs=$(mf_numprocs)
ifdef VERBOSE
$(info V: This build will use $(mf_numprocs) processor(s))
endif

# group parallel output on a per-target basis,
# and squelch unhelpful output from Make
# TODO: the --output-sync line will make stderr undetectable by stderred
override MAKEFLAGS+= --output-sync=target
override MAKEFLAGS+= --no-print-directory



# TODO: these should be specific to the host OS
override mfobj:=o
override mflib:=a
override mfexe:=
override mfdll:=so


# TODO: some of these may be specific to the host OS
ifdef TEST
    override test:=echo
    override test2:=>/dev/null $(test)
    override pipe:=\|
    override redir:=\>
    override indir:=\<
    override append:=\>\>
    ifeq ($(TEST),2)
        override test2:=$(test)
    endif
else
    override test:=
    override test2:=
    override pipe:=|
    override redir:=>
    override indir:=<
    override append:=>>
endif

ifdef DEBUG
    override CXXFLAGS+= -ggdb3 -O0
endif

override empty:=
override tab:=$(empty)	$(empty)
override space:=$(empty) $(empty)

override echo:=echo
ifdef MF_QUIET_BUILDS
    override echo:=>/dev/null echo
endif


# save off the original values of CXXFLAGS, etc, so that we
# can restore them a the start of every target declaration
override MF_CFLAGS:=$(CFLAGS)
override MF_LDFLAGS:=$(LDFLAGS)
override MF_CPPFLAGS:=$(CPPFLAGS)
override MF_CXXFLAGS:=$(CXXFLAGS)

# traditionally, ARFLAGS defaults to 'rv', but we like 'rcs' here
override MF_ARFLAGS:=rcs

# ---------------------------------------------------------------------
# INTERNAL:     __mf_initialize
# Description:  Resets internal state, in preparation for
#               mf_declare_target, et al.
# ---------------------------------------------------------------------
define __mf_initialize =
    $(eval override LDLIBS:=)
    $(eval override CFLAGS:=$(MF_CFLAGS))
    $(eval override ARFLAGS:=$(MF_ARFLAGS))
    $(eval override LDFLAGS:=$(MF_LDFLAGS))
    $(eval override CPPFLAGS:=$(MF_CPPFLAGS))
    $(eval override CXXFLAGS:=$(MF_CXXFLAGS))
    $(eval override mf_suffix:=)
    $(eval override mf_printsuffix:=)
    $(eval override mf_srcfiles:=)
    $(eval override mf_objfiles:=)
    $(eval override mf_depfiles:=)
    $(eval override mf_libfiles:=)
    $(eval override mf_linkfiles:=)
    $(eval override mf_deptargets:=)
endef


# ---------------------------------------------------------------------
# Function:     mf_declare_target(name)
# Description:  Declares to make-forge that a new build-target named
#               'name' is about to be described.
# Arguments: 1: name of the build-target being described
# ---------------------------------------------------------------------
define mf_declare_target =
    $(eval $(call __mf_initialize))
    $(eval override mf_target:=$(1)$(MF_NAMESPACE))
    $(eval override mf_outdir:=$(MFOUT))
endef


# ---------------------------------------------------------------------
# Function:     mf_set_object_suffix(suffix)
# Description:  Sets a filename stem suffix for every object file
#               built for this build-target
# ---------------------------------------------------------------------
define mf_set_object_suffix =
    $(eval override mf_suffix:=_$(1))
    $(eval override mf_printsuffix:=($(1)))
endef


# ---------------------------------------------------------------------
# INTERNAL:     __mf_announce_compile
# Description:  echo standardized string to announce source compilation
# ---------------------------------------------------------------------
define __mf_announce_compile =
	@$(echo) "+++ [$$(notdir $(mf_target))] $$(notdir $$<)$(tab)$(1)"
endef


# ---------------------------------------------------------------------
# INTERNAL:     __mf_compile_c++
# Description:  compile a C++ source file
# ---------------------------------------------------------------------
define __mf_compile_c =
	@$(call __mf_announce_compile,$(1))
	@$(test) $(CC) $(CPPFLAGS) $(CFLAGS) -c $$< -o $$@
endef


# ---------------------------------------------------------------------
# INTERNAL:     __mf_compile_c++
# Description:  compile a C++ source file
# ---------------------------------------------------------------------
define __mf_compile_c++ =
	@$(call __mf_announce_compile,$(1))
	@$(test) $(CXX) $(CPPFLAGS) $(CFLAGS) $(CXXFLAGS) -c $$< -o $$@
endef


# ---------------------------------------------------------------------
# INTERNAL: generate source/header dependency info
#
# This is based on Scott McPeak's "Autodependencies with GNU make"
# described at http://scottmcpeak.com/autodepend/autodepend.html
#
#    $(CXX):   use compiler to generate .d file
#    mv:       rename .d file to .d.tmp
# transform .d.tmp into a usable .d with:
#    sed:      use FQPN for target
# additionally, the following ensures that the build still succeeds
# if source files get renamed while .d files exist:
#    echo:     add blank line
#    sed:    - strip the target (up-to and including colon)
#            - remove any continuation backslash
#    fmt -1:   list 'words' (files) one per line
#    sed:    - strip leading spaces
#            - add trailing colons (and blank lines)
#            - remove lines containing only a colon
# ---------------------------------------------------------------------
define __mf_gen_dependencies =
	@$(test2) $(CXX) -MM $(CPPFLAGS) $(CXXFLAGS) $$< $(redir)$(mf_outdir)/$(1).d
	@$(test2) mv -f $(mf_outdir)/$(1).d $(mf_outdir)/$(1).d.tmp
	@$(test2) sed -e 's|.*:|$(mf_outdir)/$(1).o:|' $(indir)$(mf_outdir)/$(1).d.tmp $(redir)$(mf_outdir)/$(1).d
	@$(test2) echo "" $(append)$(mf_outdir)/$(1).d
	@$(test2) sed -e 's/.*://' \
	              -e 's/\\$$$$//' $(indir)$(mf_outdir)/$(1).d.tmp $(pipe) \
	 $(test2) fmt -1 $(pipe) \
	 $(test2) sed -e 's/^ *//' \
	              -e 's/$$$$/:\n/' \
	              -e 's/^:.*$$$$/\n/' $(append)$(mf_outdir)/$(1).d
	@$(test2) $(RM) $(mf_outdir)/$(1).d.tmp
endef


# ---------------------------------------------------------------------
# INTERNAL:     __mf_gen_static_pattern_rule_c++(obj, dir, glob)
# Description:  Generates a gnu-make "static pattern rule" based on
#               the passed-in arguments.
# Arguments: 1: The type of source code
#            2: FQPN of the object file that is the target of this rule
#            3: the directory where the source(s) are located
#            4: the file name (or file glob) to be compiled. (This
#               may have been name-mangled with mf_suffix)
# ---------------------------------------------------------------------
define __mf_gen_static_pattern_rule
    $(2): $(mf_outdir)/%$(mf_suffix).$(mfobj): $(3)/%$(4) | $(mf_outdir)
	@$(call __mf_compile_$(1),$(mf_printsuffix))
	@$(call __mf_gen_dependencies,$$*$(mf_suffix))
endef


# ---------------------------------------------------------------------
# Function:     mf_add_sources(lang, dir, glob)
# Description:  Declares which sources need to be build for the current
#               target.  (This may be invoked multiple times as needed,
#               in each target.)
# Arguments: 1: name of the language being compiled (c++)
#            2: the directory where the source(s) are located
#            3: the file name (or file glob) to be compiled
# ---------------------------------------------------------------------
define mf_add_sources =
    $(eval override _mfas_src:=$(wildcard $(2)/$(3)))
    $(eval override _mfas_ext:=$(suffix $(3)))
    $(eval override _mfas_obj:=$(subst $(_mfas_ext),$(mf_suffix).$(mfobj),$(_mfas_src)))
    $(eval override _mfas_obj:=$(subst $(2),$(mf_outdir),$(_mfas_obj)))
    $(eval override mf_srcfiles+=$(_mfas_src))
    $(eval override mf_objfiles+=$(_mfas_obj))
    $(eval $(call __mf_gen_static_pattern_rule,$(1),$(_mfas_obj),$(2),$(_mfas_ext)))
    $(eval undefine _mfas_src)
    $(eval undefine _mfas_ext)
    $(eval undefine _mfas_obj)
endef


# ---------------------------------------------------------------------
# INTERNAL:     __mf_static_lib_dependency(target)
# Description:  support routine for mf_static_dependencies
# Arguments: 1: name of the build-target that builds the static
#               library that the current-target is dependendent upon.
#               From this, the library's filename is inferred to be
#               stored in mf_<target>_final
# ---------------------------------------------------------------------
define __mf_static_lib_dependency =
    $(eval override _mfsld_target:=$(1))
    $(eval override _mfsld_libfile:=$(mf_$(_mfsld_target)_final))
    $(eval override mf_deptargets+=$(_mfsld_target))
    $(eval override mf_linkfiles+=$(_mfsld_libfile))
    $(eval undefine _mfsld_libfile)
    $(eval undefine _mfsld_target)
endef


# ---------------------------------------------------------------------
# Function:     mf_static_dependencies(targets)
# Description:  Declares the current-target's static-lib linkage dependencies
# Arguments: 1: space-delimited list of build-targets
# ---------------------------------------------------------------------
define mf_static_dependencies =
    $(eval override _mfsd_targets:=$(1))
    $(foreach target,$(_mfsd_targets),$(eval $(call __mf_static_lib_dependency,$(target))))
    $(eval undefine _mfsd_targets)
endef


# ---------------------------------------------------------------------
# INTERNAL:     __mf_import_depfiles
# Description:  Support routine for mf_build_xxxxx routines
#               Includes (when present) all .d files that match the
#               target's objfiles
# ---------------------------------------------------------------------
define __mf_import_depfiles =
    $(eval override mf_depfiles:=$(mf_objfiles:.$(mfobj)=.d))
    -include $(mf_depfiles)
endef


# ---------------------------------------------------------------------
# INTERNAL:     __mf_delete_mfout_files
# Description:  Helper routine to __mf_gen_cleantarget
# ---------------------------------------------------------------------
define __mf_delete_mfout_files =
    $(eval override _name:=$(1))
	@([ -e $(MFOUT) ] && $(test) $(RM) $($(_name))) || true
endef


# ---------------------------------------------------------------------
# INTERNAL:     __mf_gen_cleantarget(target,filelist)
# Description:  Generates a clean-target for the current-target, and
#               adds it to the global list of clean-targets (to be
#               used by target 'clean')
# Arguments: 1: Name of the current-target (TODO: could just assume mf_target)
#            2: Space-delimited list of files to be deleted
# ---------------------------------------------------------------------
define __mf_gen_cleantarget =
    # TODO: just use mf_target instead of passing it in as arg?
    $(eval override _mfgc_target:=$(1))
    $(eval override _mfgc_varnames:=$(2))

    .PHONY: _clean_$(_mfgc_target)$(MF_NAMESPACE)
    _clean_$(_mfgc_target)$(MF_NAMESPACE):
	@([ -e $(MFOUT) ] && $(echo) "+++ [$(_mfgc_target)] Cleaning...") || true
	$(foreach _var,$(_mfgc_varnames),$(call __mf_delete_mfout_files,$(_var)))

    $(eval override mf_clean_targets+=_clean_$(_mfgc_target))
endef


# ---------------------------------------------------------------------
#  INTERNAL:     __mf_build_final_target(filename,string)
#  Description:  Generates the 'final' target file of the current-target
#  Arguments: 1: The filename (stem[.ext]) of the file to be generated.
#             2: A string describing the type of file being built
# ---------------------------------------------------------------------
define __mf_build_final_target =
    $(eval override mf_$(mf_target)_final:=$(mf_outdir)/$(1))
    $(eval $(__mf_import_depfiles))
    $(eval override mf_objfiles:=$(sort $(mf_objfiles)))
    $(eval override mf_linkfiles:=$(sort $(mf_linkfiles)))

    $(mf_target): $(mf_deptargets) $(mf_$(mf_target)_final)

    $(eval $(call __mf_gen_cleantarget,$(mf_target),mf_objfiles mf_depfiles mf_$(mf_target)_final))
    $(mf_$(mf_target)_final): $(mf_objfiles) $(mf_linkfiles)
	@$(echo) +++ [$(mf_target)] Generating $(2) \'$$(notdir $$@)\'...
endef


# ---------------------------------------------------------------------
#  Function:     mf_build_static_library(stem)
#  Description:  This end the target definition for a static library
#  Arguments: 1: The stem of the static library's intended filename
# ---------------------------------------------------------------------
define mf_build_static_library =
    $(call __mf_build_final_target,$(1).$(mflib),static library)
	@$(test) $(AR) $(ARFLAGS) $$@ $$^
endef


# ---------------------------------------------------------------------
#  Function:     mf_build_shared_library(stem)
#  Description:  This end the target definition for a shared library
#  Arguments: 1: The stem of the shared library's intended filename
# ---------------------------------------------------------------------
define mf_build_shared_library =
    $(eval override LDFLAGS+=-shared)
    $(call __mf_build_final_target,$(1).$(mfdll),shared library)
	@$(test) $(CXX) $(LDFLAGS) $$^ -o $$@
endef


# ---------------------------------------------------------------------
#  Function:     mf_build_executable(stem)
#  Description:  This end the target definition for an executable
#  Arguments: 1: The stem of the executable's intended filename
# ---------------------------------------------------------------------
define mf_build_executable =
    $(call __mf_build_final_target,$(1)$(mfexe),executable)
	@$(test) $(CXX) $(LDFLAGS) $$^ $(LDLIBS) -o $$@
endef


define mf_include_as =
    $(eval override MF_NAMESPACE:=@$(1))
    $(eval include $(2))
    $(eval override undefine MF_NAMESPACE)
endef


# each release adds another digit of i^i
mf_version_major:=0
mf_version_minor:=20787
mf_version_text:=... (beta release "i^i")
version::
	@echo "( build/test system: MAKE-FORGE, version $(mf_version_major).$(mf_version_minor)$(mf_version_text) )"
	@echo ""


$(eval $(call __mf_initialize))

endif  # __mf_common_include_guard
